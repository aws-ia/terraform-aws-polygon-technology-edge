# Polygon Edge Partner Solution on AWS—Terraform module

Polygon Edge is a modular and extensible framework for building Ethereum-compatible blockchain networks. For more information, refer to the [Polygon website](https://polygon.technology/) and the [Polygon Edge documentation](https://docs.polygon.technology/docs/edge/overview/).

This Partner Solution uses a Terraform module to deploy a dedicated Polygon Edge blockchain to the Amazon Web Services (AWS) Cloud using the proof-of-authority consensus mechanism. This solution is for developers of enterprise decentralized applications (dApps) who want to design, develop, and test blockchain applications.

### Architecture

<p>
  <img src="https://github.com/aws-ia/terraform-aws-polygon-technology-edge/blob/main/images/polygon-architecture-diagram.png" alt="Architecture for Polygon Edge on AWS" width="100%">
</p>

As shown in the diagram, this Partner Solution sets up the following:

* A highly available architecture that spans four Availability Zones.*
* A virtual private cloud (VPC) configured with public and private subnets, according to AWS best practices, to provide you with your own virtual network on AWS.*
* In the public subnets, managed NAT gateways to allow outbound internet access for resources in the private subnets.
* In the private subnets, Polygon Edge deployed to Amazon Elastic Compute Cloud (Amazon EC2) instances, one per Availability Zone. These nodes serve as blockchain validators.
* An Application Load Balancer to distribute JSON-RPC requests across the Polygon Edge nodes.
* Amazon CloudWatch to monitor the VPC and generate flow logs.
* AWS Systems Manager to securely store each Polygon Edge node's validator keys in a Parameter Store and to update and manage the nodes.
* AWS Lambda to generate the genesis.json file that bootstraps the Polygon Edge nodes.
* A private, encrypted Amazon Simple Storage Service (Amazon S3) bucket to share the genesis file among the Polygon Edge nodes.
* AWS PrivateLink (not shown) for connecting to Amazon S3 and Systems Manager services over private networking.
* Dedicated security groups and IAM roles (not shown).

*If you configure the module to deploy the Partner Solution into an existing VPC, the deployment skips the components marked by asterisks.

### Prerequisites

You must provide these three variables before you deploy this solution:

* `account_id` - The AWS account ID that the Polygon Edge blockchain cluster will be deployed on.
* `alb_ssl_certificate` - The Amazon Resource Name (ARN) of the certificate from AWS Certificate Manager to be used by the Application Load Balancer for https protocol. 
The certificate must be generated before starting the deployment, and it must have an **Issued** status.
* `premine` - The account or accounts that will receive premined native currency.
Value must follow the official [CLI flag specification](https://docs.polygon.technology/docs/edge/get-started/cli-commands#genesis-flags).

### Fault tolerance

This deployment requires AWS Regions that have 4 Availability Zones. Each node is deployed in a single Availability Zone. 
By placing each node in a single Availability Zone, the whole blockchain cluster is fault-tolerant to a single node (Availability Zone) failure since Polygon Edge implements IBFT 
consensus. This allows a single node to fail in a four-validator-node cluster.

### Command-line access

Validator nodes are not exposed to the public internet (JSON-PRC is accessed only by the Application Load Balancer), 
and they don't even have public IP addresses attached to them.  
The nodes' command-line access is possible only by AWS Systems Manager Session Manager. 

### Base AMI upgrade

This deployment uses the `ubuntu-focal-20.04-amd64-server` AWS AMI. It will not trigger EC2 redeployment if the AWS AMI gets updated.

If the base AMI must be updated, 
you can update it by running the `terraform taint` command for each instance before `terraform apply`.   
Instances can be tainted by running the `terraform taint module.instances[<instance_number>].aws_instance.polygon_edge_instance` command.

Example:
```shell
terraform taint module.instances[0].aws_instance.polygon_edge_instance
terraform taint module.instances[1].aws_instance.polygon_edge_instance
terraform taint module.instances[2].aws_instance.polygon_edge_instance
terraform taint module.instances[3].aws_instance.polygon_edge_instance
terraform apply
```

### Resources cleanup

When cleaning up all resources by running `terraform destory`, the only things you must delete manually 
are **validator keys** from **AWS SSM Parameter Store** since they are not stored using Terraform but with the `polygon-edge` 
process itself.

### Customer responsibility
After you deploy this Partner Solution, confirm that your resources and services are updated and configured—including any required patches—to meet your security and other needs. For more information, refer to the [AWS Shared Responsibility Model](https://aws.amazon.com/compliance/shared-responsibility-model/).

<!--- Shivansh, Is this how to do a comment in an .md file? --->
<!--- Shivansh, Seems like we should include this section, above, on customer responsibility as part of our documentation, required for every solution, yes? I don't know why we'd make an exception for Terraform, do you? --->
<!--- Shivansh, Seems like we should add a statement about costs of AWS services, as in our other deployment guides and landing pages. Any reason to make an exception for Terraform? --->
<!--- Shivansh, You mentioned that every Terraform readme should have a "Usage" section with copy-paste code. Please advise.--->
 